---
title: "Preprocess"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

ipak <- function(pkg){
    new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
    if (length(new.pkg)) 
        install.packages(new.pkg, dependencies = TRUE)
    sapply(pkg, require, character.only = TRUE)
}

# usage
packages <- c("factoextra", "dplyr", "psych", "kableExtra", "reshape2", "ggplot2", "compareGroups", "ggpubr", "mice")
ipak(packages)


```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r impute, echo=FALSE, warning=FALSE}

#replace infinite with NA
et_select_comp[mapply(is.infinite, et_select_comp)] <- NA

# replace NaN with NA
et_select_comp[mapply(is.nan, et_select_comp)] <- NA

# record missing values

vars <- colnames(et_select_comp)

missing_analysis <- as.data.frame(matrix(NA, nrow=length(vars), ncol=2))

j=1

for (i in vars){

  missing_analysis[j,1] <- i
  missing_analysis[j,2] <- sum(is.na(et_select_comp[,colnames(et_select_comp)==i]))/length(et_select_comp[,colnames(et_select_comp)==i])
  
  j = j+1
}


write.csv2(missing_analysis, "../databases/missing_analysis.csv")

x <- md.pattern(et_raw)

if (sum(is.na(et_select_comp)) > 0 & nrow(et_select_comp) >= 10){

#tempData <- mice(et_select_comp,m=5,maxit=50,meth='cart',seed=500)
tempData <- mice(et_select_comp,m=5,maxit=50,meth='cart',seed=500)

summary(tempData)

et_select_imp <- complete(tempData,1:5)

et_select_imp <- aggregate(x = et_select_imp, by = list(et_select_imp$subj, et_select_imp$test), FUN = "mean")
et_select_imp <- select(et_select_imp, -c("test", "Group.1"))
colnames(et_select_imp)[1] <- "test"

} else {
  
    et_select_imp <- et_select_comp
    
    }


#filter out rows with remaining missing data
et_select_imp <- et_select_imp[complete.cases(et_select_imp), ]

write.table(et_select_imp[,-c(1)],file="../data/ET_DATABASE_IMPUTED.txt")


```



